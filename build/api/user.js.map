{"version":3,"sources":["../../server/api/user.js"],"names":["database","url","table","fs","stat","err","res","db","SQLite","Database","console","log","message","prototype","init","serialize","run","q","prepare","params","$user_id","$email","$gender","$role","$lastlog","Date","now","$credit","finalize","locations","login","credentials","fetchOne","data","result_set","that","sql","Promise","resolve","reject","get","email","row","fetchById","user_id","updateUserData","update_set","update_fields","key","push","signUpUser","username","role","credit","undefined","$username","$password","hash","stm","changes"],"mappings":"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","file":"user.js","sourcesContent":["import SQLite from 'sqlite3'\nimport fs from 'fs'\n\nfunction database(url, table) {\n  try {\n    fs.stat(url, (err,res) => {\n      if(err){\n        throw err\n      } else {\n        this.db = new SQLite.Database(url, err => {\n          if(!err) console.log('Users DB: Success')\n          if(table) {\n            //this.init(table)\n          }\n        })\n      }\n    })\n  }\n  catch(err) {\n    console.log('Wrong DB: ' + err.message)\n  }\n}\n\ndatabase.prototype.init = function(table) {\n  switch(table) {\n    case 'users' :\n      this.db.serialize(\n        () => {\n          this.db.run(\"CREATE TABLE if not exists users (\" +\n          \"user_id INTEGER PRIMARY KEY NOT NULL,\" +\n          \"email VARCHAR NOT NULL UNIQUE,\" +\n          \"password VARCHAR NOT NULL UNIQUE,\" +\n          \"verifyed INTEGER DEFAULT 0,\" +\n          \"first TEXT,\" +\n          \"last TEXT,\" +\n          \"username VARCHAR,\" +\n          \"gender INTEGER,\" +\n          \"lastlog INTEGER,\" +// DATE: last login date to calculate rating/activitie\n          \"credit REAL DEFAULT 10,\" +//20 initial, buy on PayPal\n          \"payment_metod INTEGER,\" +// default payment metod\n          \"rating REAL DEFAULT 10,\" +\n          \"role VARCHAR(4) DEFAULT 1000,\" +//role access permissions\n          \"location VARCHAR(12),\" +// Lat,Lng\n          \"country VARCHAR(5),\" +\n          \"likes REAL DEFAULT 0,\" +\n          \"id_kickstart VARCHAR,\" +//access to LiveParty content\n          \"id_indie VARCHAR,\" +//access to LiveParty content\n          \"id_insta VARCHAR,\" +//passport-session\n          \"id_fb VARCHAR,\" +//passport-session\n          \"refs VARCHAR\" +// referential program ??: How To\n          \");\")\n\n        const q = this.db.prepare(\"INSERT INTO users (user_id,email, gender, role, lastlog, credit)\" +\n                        \"VALUES ($user_id, $email, $gender, $role, $lastlog, $credit)\")\n        const params = {\n          $user_id: 100000001,\n          $email: 'valentin.mundrov@gmail.com',\n          $gender: 1,\n          $role: 9999,\n          $lastlog: Date.now(),\n          $credit: 999\n        }\n\n      q.run(params)\n      q.finalize()\n    }\n      //\n    )\n\n    break\n    case 'events' :\n      this.db.run(\"CREATE TABLE if not exists events (\" +\n        \"id VARCHAR,\" +\n        \"state INTEGER,\" +//(0=promo, 1=confirmed-comingup, 2=LiveNow!, 3=onKickstarter)\n        \"event VARCHAR,\" +//(for LIVE: Time included)\n        \"location VARCHAR,\" +\n        \"venue VARCHAR,\" +\n        \"time VARCHAR\" +\n        \");\")\n    break\n  }\n}\n\n// ------- Login: Check PASSWORD!!! ----------------\ndatabase.prototype.locations = function(table) {\n  //\n}\n\ndatabase.prototype.login = function(credentials) {\n  //\n}\n\n// ------ Fetch User: ------------------------------\ndatabase.prototype.fetchOne = function(data = [], result_set = ['email']) {\n  const that = this\n  const sql = `SELECT ${result_set}, username FROM users WHERE email = ?`\n  return new Promise ((resolve, reject) => {\n    that.db.get(sql, [ data.email ], (err,row) => {\n      if(err){\n        reject(err)\n      } else {\n    //sqlite returns rows = array\n        resolve(row)\n      }\n    })\n  })\n\n}\n\ndatabase.prototype.fetchById = function(data = [], result_set) {\n  const that = this\n  const sql = `SELECT ${result_set} FROM users WHERE user_id = ?`\n  return new Promise ((resolve, reject) => {\n    that.db.get(sql, [ data.user_id ], (err,row) => {\n      if(err){\n        reject(err)\n      } else {\n        console.log('DB returns: ' , row)\n    //sqlite returns rows = array\n        resolve(row)\n      }\n    })\n  })\n\n}\n\n// ------ Update User Data: -----------------------------\ndatabase.prototype.updateUserData = function(data = [], update_set) {\n  const update_fields = []\n  for(var key in update_set.data){\n    if(key !== 'user_id') {\n      update_fields.push(`${key}=${update_set.data[key]}`)\n    }\n  }\n  console.log('Object to update: ', update_fields)\n  const that = this\n  const sql = `UPDATE users SET ${update_fields} WHERE user_id = ?`\n  return new Promise ((resolve, reject) => {\n    this.db.run(sql, [ data.user_id ], function(err) {\n      if(err){\n        reject(err)\n      } else {\n//console.log(this)\n        resolve()\n      }\n    })\n  })\n\n}\n\n// On Sign Up record --------------------------------------\ndatabase.prototype.signUpUser = function(data) {\n  let username = 'Anon',\n      role = 1000,\n      credit = 10,\n      user_id = undefined\n  if (data.email === 'valentin.mundrov@gmail.com') {\n    username = 'Valento',\n    user_id = 100000001,\n    role = 9999,\n    credit = 999\n  } else if (data.email === 'iloveaquiles09@gmail.com') {\n    username = 'Adri',\n    user_id = 100000002,\n    role = 9999,\n    credit = 999\n  }\n  const that = this\n  return new Promise((resolve,reject) => {\n    if(!data) {\n      reject('Nothing to save')\n    }\n    let q = \"INSERT INTO users (user_id, username, email, password, role, credit)\" +\n                    \"VALUES ($user_id, $username, $email, $password, $role, $credit)\"\n    let params = {\n      $user_id: user_id,\n      $username: username,\n      $email: data.email,\n      $password: data.hash,\n      $role: role,\n      $credit: credit\n    }\n    let stm = that.db.prepare(q)\n    stm.run(params, err => {\n      if(err){\n        if(this.changes == 0) {\n          reject('Nothing saved')\n        }\n        reject(err.message)\n      }\n      else {\n        console.log(data)\n        resolve(data)\n      }\n    })\n    stm.finalize()\n  })\n}\n\nexport default database\n"]}